<!DOCTYPE html>
<html lang="vi">
<head>
    <title>EduTeacher Pro - Qu·∫£n l√Ω ƒê√†o t·∫°o</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root { 
            --primary: #6366f1; 
            --primary-dark: #4f46e5; 
            --bg-body: #f8fafc; 
            --sidebar-bg: #0f172a; 
            --text-gray: #64748b;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: #334155; }
        
        /* SIDEBAR */
        .sidebar { width: 280px; height: 100vh; position: fixed; background: var(--sidebar-bg); padding: 24px; z-index: 1000; box-shadow: 4px 0 20px rgba(0,0,0,0.05); }
        .nav-item { padding: 14px 18px; border-radius: 12px; color: #94a3b8; font-weight: 600; text-decoration: none; display: flex; align-items: center; gap: 14px; margin-bottom: 8px; transition: all 0.3s ease; cursor: pointer; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; transform: translateX(5px); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4); }
        
        /* MAIN CONTENT */
        .main-content { margin-left: 280px; padding: 40px; }
        .content-card { background: white; border-radius: 20px; border: 1px solid #e2e8f0; overflow: hidden; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
        
        /* STAT CARDS */
        .stat-card { background: white; padding: 24px; border-radius: 20px; border: 1px solid #f1f5f9; box-shadow: 0 4px 15px -3px rgba(0,0,0,0.05); transition: transform 0.2s; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        
        /* NESTED CLASS CARD (Giao di·ªán L·ªõp b√™n trong Kh√≥a) */
        .class-mini-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-bottom: 12px; position: relative; transition: 0.2s; }
        .class-mini-card:hover { background: #fff; border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        /* FORM ELEMENTS */
        .schedule-selector { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 10px; }
        .day-checkbox { display: none; }
        .day-label { display: inline-block; width: 36px; height: 36px; line-height: 36px; text-align: center; border-radius: 50%; background: white; border: 1px solid #cbd5e1; color: #64748b; font-weight: 700; font-size: 0.8rem; cursor: pointer; margin-right: 5px; transition: 0.2s; user-select: none; }
        .day-checkbox:checked + .day-label { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.1); box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3); }

        /* RECORDER BUTTON */
        #eduSmartRecorder { position: fixed; bottom: 30px; right: 30px; z-index: 9999; display: none; }
        .recorder-btn { width: 64px; height: 64px; border-radius: 50%; background: #ef4444; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; cursor: pointer; box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4); }
        .recorder-btn.recording { background: #333; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <a href="/" class="text-white text-decoration-none fs-4 fw-bold mb-5 d-block px-2">
            <i class="fas fa-layer-group text-primary"></i> EduTeacher <span class="badge bg-primary fs-6" style="vertical-align: top;"></span>
        </a>
        <a href="/teacher?tab=overview" class="nav-item <%= currentTab === 'overview' ? 'active' : '' %>"><i class="fas fa-chart-pie"></i> T·ªïng quan</a>
        <a href="/teacher?tab=calendar" class="nav-item <%= currentTab === 'calendar' ? 'active' : '' %>"><i class="fas fa-calendar-alt"></i> L·ªãch d·∫°y & L·ªõp</a>
        <a href="/teacher?tab=courses" class="nav-item <%= currentTab === 'courses' ? 'active' : '' %>"><i class="fas fa-book"></i> Qu·∫£n l√Ω Kh√≥a h·ªçc</a>
        <a href="/teacher?tab=students" class="nav-item <%= currentTab === 'students' ? 'active' : '' %>"><i class="fas fa-users"></i> Danh s√°ch H·ªçc vi√™n</a>
        <a href="/teacher?tab=finance" class="nav-item <%= currentTab === 'finance' ? 'active' : '' %>"><i class="fas fa-wallet"></i> T√†i ch√≠nh</a>
        <a href="/teacher?tab=recordings" class="nav-item <%= currentTab === 'recordings' ? 'active' : '' %>"><i class="fas fa-video"></i> Kho Video</a>
        <div style="margin-top: auto; padding-top: 50px;"><div class="nav-item text-danger" onclick="confirmLogout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</div></div>
    </div>

    <div id="eduSmartRecorder"><div class="recorder-btn" onclick="toggleRecording()" id="recBtn"><i class="fas fa-video"></i></div></div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div><h2 class="fw-bold mb-1 text-dark">Qu·∫£n l√Ω ƒê√†o t·∫°o</h2><p class="text-muted mb-0">Xin ch√†o, <strong><%= user.nickname %></strong></p></div>
            <div class="d-flex gap-3 align-items-center">
                <% if (!user.is_verified) { %> 
                    <button class="btn btn-warning fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#kycModal"><i class="fas fa-id-card me-2"></i> X√°c th·ª±c ngay</button> 
                <% } else { %>
                    <span class="badge bg-success bg-opacity-10 text-success border border-success px-3 py-2 rounded-pill"><i class="fas fa-check-circle"></i> ƒê√£ x√°c th·ª±c</span>
                    <button class="btn btn-primary fw-bold shadow-sm rounded-pill px-4" onclick="openCreateModal()"><i class="fas fa-plus me-2"></i> T·∫°o kh√≥a h·ªçc</button>
                <% } %>
            </div>
        </div>

        <% if (currentTab === 'overview') { %>
            <div class="row g-4 mb-4">
                <div class="col-md-3"><div class="stat-card border-start border-4 border-primary"><div><small class="text-muted fw-bold">DOANH THU</small><h2 class="fw-bold mb-0 text-primary"><%= stats.totalRevenue.toLocaleString() %></h2></div></div></div>
                <div class="col-md-3"><div class="stat-card border-start border-4 border-success"><div><small class="text-muted fw-bold">H·ªåC VI√äN</small><h2 class="fw-bold mb-0 text-success"><%= stats.totalStudents %></h2></div></div></div>
                <div class="col-md-3"><div class="stat-card border-start border-4 border-warning"><div><small class="text-muted fw-bold">KH√ìA H·ªåC</small><h2 class="fw-bold mb-0 text-warning"><%= stats.totalCourses %></h2></div></div></div>
                <div class="col-md-3"><div class="stat-card border-start border-4 border-info"><div><small class="text-muted fw-bold">L·ªöP ƒêANG D·∫†Y</small><h2 class="fw-bold mb-0 text-info"><%= stats.totalClasses %></h2></div></div></div>
            </div>
            <div class="row g-4">
                <div class="col-lg-8"><div class="content-card p-4 h-100"><h5 class="fw-bold mb-4">Hi·ªáu su·∫•t 7 ng√†y qua</h5><div style="height:300px"><canvas id="comboChart"></canvas></div></div></div>
                <div class="col-lg-4"><div class="content-card p-4 h-100"><h5 class="fw-bold mb-4">T·ª∑ tr·ªçng H·ªçc vi√™n</h5><div style="height:250px; display:flex; justify-content:center"><canvas id="pieChart"></canvas></div></div></div>
            </div>
        <% } %>

        <% if (currentTab === 'calendar') { %>
            <div class="content-card p-4"><div id='calendar'></div></div>
        <% } %>

        <% if (currentTab === 'courses') { %>
            <div class="content-card">
                <div class="p-4 border-bottom bg-white"><h5 class="fw-bold mb-0 text-primary">Danh s√°ch Kh√≥a h·ªçc & L·ªõp</h5></div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-light text-muted"><tr><th class="ps-4">Kh√≥a h·ªçc</th><th>L·ªõp / L·ªô tr√¨nh</th><th class="text-end pe-4">H√†nh ƒë·ªông</th></tr></thead>
                        <tbody>
                            <% if(myCourses.length > 0) { %>
                                <% myCourses.forEach(course => { %>
                                    <tr>
                                        <td class="ps-4" style="width: 25%; vertical-align: top;">
                                            <div class="fw-bold text-dark fs-5 mb-1"><%= course.title %></div>
                                            <div class="text-success fw-bold small mb-2"><i class="fas fa-tag"></i> <%= course.price_tokens %> Token/bu·ªïi</div>
                                            <% if(course.image_url) { %>
                                                <img src="<%= course.image_url %>" class="rounded shadow-sm" style="width: 100%; height: 100px; object-fit: cover;">
                                            <% } %>
                                            <div class="mt-3">
                                                <button class="btn btn-sm btn-outline-danger w-100 rounded-pill" onclick="confirmDeleteCourse('<%= course.id %>', '<%= course.title %>')"><i class="fas fa-trash-alt me-1"></i> X√≥a Kh√≥a</button>
                                            </div>
                                        </td>
                                        
                                        <td style="vertical-align: top;">
                                            <% const classes = allClasses.filter(c => c.course_id === course.id); %>
                                            <% if(classes.length > 0) { %>
                                                <div class="d-flex flex-column gap-2">
                                                <% classes.forEach(cl => { %>
                                                    <div class="class-mini-card">
                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                            <div class="fw-bold text-primary"><i class="fas fa-chalkboard me-2"></i><%= cl.name %></div>
                                                            <button class="btn btn-sm text-muted p-0" onclick="confirmDeleteClass('<%= cl.id %>', '<%= cl.name %>')" title="X√≥a l·ªõp"><i class="fas fa-times"></i></button>
                                                        </div>
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="badge bg-light text-primary border"><i class="fas fa-users"></i> <%= cl.enrolled %>/<%= cl.capacity %></span>
                                                            <small class="text-muted"><i class="far fa-clock"></i> <%= cl.schedule %></small>
                                                        </div>
                                                        <div class="small text-muted mt-1 mb-2"><i class="far fa-calendar-alt"></i> <%= cl.start_date %> &rarr; <%= cl.end_date %></div>
                                                        <button class="btn btn-sm btn-primary w-100 rounded-pill fw-bold shadow-sm" onclick="openClassSessionModal('<%= cl.name %>', '<%= cl.enrolled %>', '<%= cl.capacity %>', '<%= cl.presentToday || 0 %>', '<%= cl.meeting_url %>')">V√†o l·ªõp d·∫°y</button>
                                                    </div>
                                                <% }); %>
                                                </div>
                                            <% } else { %><div class="text-muted fst-italic py-3 text-center">Ch∆∞a c√≥ l·ªõp n√†o ƒë∆∞·ª£c t·∫°o.</div><% } %>
                                        </td>

                                        <td class="text-end pe-4" style="vertical-align: top;">
                                            <button class="btn btn-light text-primary fw-bold border shadow-sm" onclick="openEditCourseModal('<%= course.id %>')"><i class="fas fa-edit me-1"></i> Ch·ªânh s·ª≠a</button>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %><tr><td colspan="3" class="text-center py-5 text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr><% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        <% } %>

        <% if (currentTab === 'students') { %>
            <div class="content-card">
                <div class="p-4 border-bottom bg-white"><h5 class="fw-bold mb-0">H·ªì s∆° H·ªçc vi√™n (Theo L·ªõp)</h5></div>
                <div class="p-3">
                    <div class="accordion accordion-flush" id="studentsAccordion">
                        <% if(classesWithStudents && classesWithStudents.length > 0) { %>
                            <% classesWithStudents.forEach((clsData, index) => { %>
                                <div class="accordion-item shadow-sm border mb-3 rounded-3 overflow-hidden">
                                    <h2 class="accordion-header" id="heading<%= index %>">
                                        <button class="accordion-button <%= index !== 0 ? 'collapsed' : '' %> py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>">
                                            <div class="d-flex align-items-center w-100 justify-content-between pe-3">
                                                <span><i class="fas fa-chalkboard text-warning me-2"></i> <strong><%= clsData.className %></strong> <small class="text-muted"> | <%= clsData.courseName %></small></span>
                                                <span class="badge bg-light text-dark border"><%= clsData.students.length %> HV</span>
                                            </div>
                                        </button>
                                    </h2>
                                    <div id="collapse<%= index %>" class="accordion-collapse collapse <%= index === 0 ? 'show' : '' %>" data-bs-parent="#studentsAccordion">
                                        <div class="accordion-body p-0">
                                            <table class="table table-hover mb-0 align-middle">
                                                <thead class="bg-light text-secondary small"><tr><th class="ps-4">H·ªçc vi√™n</th><th>ID</th><th>V√≠ Token</th><th>Ng√†y tham gia</th><th class="text-end pe-4">ƒêi·ªÉm danh</th></tr></thead>
                                                <tbody>
                                                    <% if(clsData.students.length > 0) { %>
                                                        <% clsData.students.forEach(st => { %>
                                                            <tr>
                                                                <td class="ps-4 fw-bold"><img src="<%= st.avatar %>" width="30" class="rounded-circle me-2"> <%= st.name %></td>
                                                                <td class="text-muted"><%= st.custom_id %></td>
                                                                <td class="fw-bold text-success"><%= st.wallet %></td>
                                                                <td class="small text-muted"><%= new Date(st.enrollDate).toLocaleDateString('vi-VN') %></td>
                                                                <td class="text-end pe-4"><button class="btn btn-success btn-sm rounded-pill px-3 shadow-sm" onclick="checkIn('<%= st.id %>', '<%= clsData.classId %>')">ƒêi·ªÉm danh</button></td>
                                                            </tr>
                                                        <% }); %>
                                                    <% } else { %><tr><td colspan="5" class="text-center py-3 text-muted">Ch∆∞a c√≥ h·ªçc vi√™n.</td></tr><% } %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %><div class="text-center py-5 text-muted">Ch∆∞a c√≥ l·ªõp n√†o.</div><% } %>
                    </div>
                </div>
            </div>
        <% } %>

        <% if (currentTab === 'finance') { %>
            <div class="row g-4 mb-4">
                <div class="col-md-6"><div class="stat-card bg-primary text-white h-100"><div><small class="opacity-75 fw-bold">T·ªîNG THU NH·∫¨P</small><h2 class="fw-bold mb-0 mt-2"><%= stats.totalRevenue %></h2></div></div></div>
                <div class="col-md-6"><div class="stat-card h-100"><div><small class="text-muted fw-bold">S·ªê D∆Ø V√ç</small><h2 class="fw-bold mb-0 mt-2"><%= user.wallet_tokens %></h2></div><button class="btn btn-dark fw-bold mt-3 rounded-pill px-4">R√∫t ti·ªÅn</button></div></div>
            </div>
            <div class="content-card">
                <div class="p-4 border-bottom"><h5 class="fw-bold mb-0">L·ªãch s·ª≠ giao d·ªãch</h5></div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light"><tr><th class="ps-4">Th·ªùi gian</th><th>N·ªôi dung</th><th>ƒê·ªëi t√°c</th><th>Bi·∫øn ƒë·ªông</th></tr></thead>
                        <tbody>
                            <% if(transactionHistory.length > 0) { %><% transactionHistory.forEach(tx => { %><tr><td class="ps-4 text-muted small"><%= new Date(tx.time).toLocaleString('vi-VN') %></td><td><%= tx.content %></td><td class="fw-bold"><%= tx.student %></td><td class="fw-bold text-success">+<%= tx.amount %> Token</td></tr><% }); %><% } else { %><tr><td colspan="4" class="text-center py-5">Ch∆∞a c√≥ giao d·ªãch.</td></tr><% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        <% } %>

        <% if (currentTab === 'recordings') { %>
            <div class="content-card"><div class="table-responsive"><table class="table table-custom table-hover mb-0"><thead><tr><th class="ps-4">Ng√†y ghi</th><th>Video</th><th>L·ªõp</th><th>Quy·ªÅn t·∫£i</th><th>Xem</th></tr></thead><tbody><% if (recordings && recordings.length > 0) { %><% recordings.forEach(rec => { %><tr><td class="ps-4 text-muted"><%= new Date(rec.recorded_at).toLocaleString('vi-VN') %></td><td><%= rec.file_name %></td><td><%= rec.courseTitle %> (<%= rec.class_name %>)</td><td><div class="form-check form-switch"><input class="form-check-input" type="checkbox" <%= rec.allow_download ? 'checked' : '' %> onchange="toggleDownload('<%= rec.id %>')"></div></td><td><a href="<%= rec.video_path %>" target="_blank" class="btn btn-sm btn-light border">Xem</a></td></tr><% }); %><% } else { %><tr><td colspan="5" class="text-center py-5">Tr·ªëng</td></tr><% } %></tbody></table></div></div>
        <% } %>
    </div>

    <div class="modal fade" id="courseModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-bottom-0 pb-0"><h5 class="modal-title fw-bold" id="courseModalTitle">Thi·∫øt l·∫≠p kh√≥a h·ªçc</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-4">
                    <form id="courseForm" method="POST" action="/create-course" onsubmit="prepareData(event)">
                        <input type="hidden" name="id" id="courseId">
                        <div class="row">
                            <div class="col-md-4 border-end pe-4">
                                <h6 class="text-primary fw-bold mb-3">1. Th√¥ng tin chung</h6>
                                <div class="mb-3"><label class="small fw-bold text-muted">T√™n m√¥n h·ªçc</label><input type="text" name="title" id="inpTitle" class="form-control" required></div>
                                <div class="mb-3"><label class="small fw-bold text-muted">Gi√° 1 bu·ªïi (Token)</label><input type="number" name="price" id="inpPrice" class="form-control fw-bold" value="1"></div>
                                <div class="mb-3"><label class="small fw-bold text-muted">·∫¢nh b√¨a (URL)</label><input type="text" name="image_url" id="inpImage" class="form-control"></div>
                                <div class="mb-3"><label class="small fw-bold text-muted">M√¥ t·∫£</label><textarea name="description" id="inpDesc" class="form-control" rows="3"></textarea></div>
                            </div>
                            <div class="col-md-8 ps-4">
                                <div class="d-flex justify-content-between align-items-center mb-3"><h6 class="text-primary fw-bold mb-0">2. Danh s√°ch L·ªõp h·ªçc (K√®m l·ªô tr√¨nh)</h6><button type="button" class="btn btn-sm btn-outline-primary fw-bold rounded-pill px-3" onclick="addClassItem()"><i class="fas fa-plus"></i> Th√™m l·ªõp</button></div>
                                <div id="classListContainer" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        <input type="hidden" name="classes" id="classesJson">
                        <div class="text-end mt-4 pt-3 border-top"><button type="button" class="btn btn-light rounded-pill fw-bold px-4 me-2" data-bs-dismiss="modal">H·ªßy</button><button class="btn btn-primary rounded-pill fw-bold px-5" id="btnSave">L∆∞u & ƒêƒÉng</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="kycModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content"><div class="modal-header border-bottom-0 pb-0"><h5 class="modal-title fw-bold">X√°c th·ª±c danh t√≠nh ƒë·ªëi t√°c</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form action="/submit-kyc" method="POST" enctype="multipart/form-data" id="kycForm"><div class="mb-4"><label class="fw-bold small mb-2 text-muted">B·∫°n l√† ai?</label><select name="kyc_type" id="kycType" class="form-select p-3 fw-bold bg-light border-0" onchange="toggleKYCForm()"><option value="student_creator">üéì Sinh vi√™n b√°n kh√≥a h·ªçc</option><option value="professional_teacher">üë®‚Äçüè´ Gi·∫£ng vi√™n / Chuy√™n gia</option></select></div><div id="studentFields"><div class="alert alert-info small border-0"><i class="fas fa-info-circle"></i> C·∫ßn cung c·∫•p Th·∫ª SV v√† B·∫£ng ƒëi·ªÉm.</div><div class="mb-3"><label class="fw-bold small mb-1">M√£ S·ªë Sinh Vi√™n</label><input type="text" name="student_id" class="form-control" required></div><div class="row"><div class="col-md-6 mb-3"><label class="fw-bold small mb-1">·∫¢nh Th·∫ª Sinh Vi√™n</label><input type="file" name="student_card_image" class="form-control" required></div><div class="col-md-6 mb-3"><label class="fw-bold small mb-1">B·∫£ng ƒêi·ªÉm</label><input type="file" name="transcript_image" class="form-control" required></div></div></div><div id="teacherFields" style="display: none;"><div class="alert alert-primary small border-0"><i class="fas fa-certificate"></i> C·∫ßn cung c·∫•p B·∫±ng c·∫•p/Ch·ª©ng ch·ªâ.</div><div class="mb-3"><label class="fw-bold small mb-1">ƒê∆°n v·ªã c√¥ng t√°c</label><input type="text" name="work_place" class="form-control" disabled></div><div class="row"><div class="col-md-6 mb-3"><label class="fw-bold small mb-1">S·ªë hi·ªáu VƒÉn b·∫±ng</label><input type="text" name="degree_number" class="form-control" disabled></div><div class="col-md-6 mb-3"><label class="fw-bold small mb-1">·∫¢nh ch·ª•p B·∫±ng c·∫•p</label><input type="file" name="degree_image" class="form-control" disabled></div></div></div><button class="btn btn-success w-100 py-3 fw-bold mt-2">G·ª¨I H·ªí S∆† X√âT DUY·ªÜT</button></form></div></div>
        </div>
    </div>

    <div class="modal fade" id="classSessionModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg rounded-4"><div class="modal-header bg-primary text-white border-0"><h5 class="modal-title fw-bold">B·∫Øt ƒë·∫ßu bu·ªïi h·ªçc</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><h4 class="text-center fw-bold text-dark mb-1" id="popupClassName">L·ªõp A</h4><div class="row g-3 my-4"><div class="col-4 text-center"><h3 class="fw-bold" id="popupTotal">0/30</h3><small>Sƒ© s·ªë</small></div><div class="col-4 text-center"><h3 class="fw-bold text-success" id="popupPresent">0</h3><small>ƒê√£ v√†o</small></div><div class="col-4 text-center"><h3 class="fw-bold text-danger" id="popupAbsent">0</h3><small>Ch∆∞a v√†o</small></div></div><input type="hidden" id="popupMeetingUrl"><div class="d-grid"><button class="btn btn-primary fw-bold py-3 rounded-pill" onclick="startClassAndRecord()">V√†o l·ªõp & Ghi h√¨nh</button></div></div></div></div></div>

    <div class="modal fade" id="logoutModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content text-center p-3"><h5 class="mb-3">ƒêƒÉng xu·∫•t?</h5><div class="d-flex gap-2 justify-content-center"><button class="btn btn-light flex-fill" data-bs-dismiss="modal">Kh√¥ng</button><a href="/logout" class="btn btn-danger flex-fill">C√≥</a></div></div></div></div>

    <script>
        <% if (currentTab === 'calendar' && typeof calendarEvents !== 'undefined') { %>
            document.addEventListener('DOMContentLoaded', function() {
                var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                    initialView: 'timeGridWeek', locale: 'vi', firstDay: 1, 
                    headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,dayGridMonth' },
                    events: <%- JSON.stringify(calendarEvents) %>, slotMinTime: "07:00:00", slotMaxTime: "22:00:00",
                    eventClick: function(info) { const p = info.event.extendedProps; openClassSessionModal(p.className, p.enrolled, p.capacity, p.present, p.meetingUrl); }
                }); calendar.render();
            });
        <% } %>

        <% if(currentTab === 'overview' && chartData) { %>
            const ctxCombo = document.getElementById('comboChart').getContext('2d');
            new Chart(ctxCombo, { type: 'bar', data: { labels: <%- JSON.stringify(chartData.labels) %>, datasets: [{ label: 'Doanh thu', data: <%- JSON.stringify(chartData.revenue) %>, backgroundColor: '#6366f1', order: 2, yAxisID: 'y' }, { label: 'ƒêi·ªÉm danh', data: <%- JSON.stringify(chartData.attendance) %>, type: 'line', borderColor: '#ef4444', backgroundColor: '#ef4444', borderWidth: 2, tension: 0.3, order: 1, yAxisID: 'y1' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { position: 'left' }, y1: { position: 'right', grid: {drawOnChartArea: false} } } } });
            if(document.getElementById('pieChart')) { new Chart(document.getElementById('pieChart'), { type: 'doughnut', data: { labels: <%- JSON.stringify(chartData.pieLabels) %>, datasets: [{ data: <%- JSON.stringify(chartData.pieData) %>, backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'bottom'} } } }); }
        <% } %>

        // [FIX L·ªñI CRASH] H√†m g·ªçi API an to√†n
        async function fetchAPI(url, options = {}) {
            const headers = { 'Accept': 'application/json', 'Content-Type': 'application/json', ...options.headers };
            try {
                const res = await fetch(url, { ...options, headers });
                // Check 401: H·∫øt session
                if (res.status === 401) { alert("Phi√™n ƒëƒÉng nh·∫≠p h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i."); window.location.href = '/login'; return null; }
                // Check HTML response
                const contentType = res.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") === -1) { throw new Error("Server Error (HTML)"); }
                return await res.json();
            } catch (e) { console.error(e); alert("L·ªói k·∫øt n·ªëi ho·∫∑c h·∫øt phi√™n. Th·ª≠ F5 ho·∫∑c ƒëƒÉng nh·∫≠p l·∫°i."); return { success: false, message: e.message }; }
        }

        async function confirmDeleteClass(classId, className) {
            if (confirm(`‚ö†Ô∏è X√≥a l·ªõp "${className}"?`)) {
                const data = await fetchAPI('/delete-class', { method: 'POST', body: JSON.stringify({ classId }) });
                if (data && data.success) { alert('ƒê√£ x√≥a l·ªõp!'); location.reload(); } else if (data) { alert(data.message); }
            }
        }

        async function confirmDeleteCourse(courseId, courseTitle) {
            if (confirm(`‚ö†Ô∏è X√≥a kh√≥a "${courseTitle}"?\nC·∫£nh b√°o: Ph·∫£i x√≥a h·∫øt c√°c l·ªõp con tr∆∞·ªõc.`)) {
                const data = await fetchAPI('/delete-course', { method: 'POST', body: JSON.stringify({ courseId }) });
                if (data && data.success) { alert('ƒê√£ x√≥a kh√≥a h·ªçc!'); location.reload(); } else if (data) { alert(data.message); }
            }
        }

        async function checkIn(sid, cid) {
            const data = await fetchAPI('/attendance', { method: 'POST', body: JSON.stringify({ learnerId: sid, courseId: cid }) });
            if (data && data.message) alert(data.message);
        }

        function openCreateModal() { document.getElementById('courseForm').action = '/create-course'; document.getElementById('courseModalTitle').innerText = "Thi·∫øt l·∫≠p kh√≥a h·ªçc m·ªõi"; document.getElementById('courseId').value = ""; document.getElementById('inpTitle').value = ""; document.getElementById('inpPrice').value = "1"; document.getElementById('inpImage').value = ""; document.getElementById('inpDesc').value = ""; document.getElementById('classListContainer').innerHTML = ""; addClassItem(); new bootstrap.Modal(document.getElementById('courseModal')).show(); }
        async function openEditCourseModal(id) { 
            const data = await fetchAPI(`/api/course/${id}`);
            if (data && !data.error) {
                document.getElementById('courseForm').action = '/edit-course'; document.getElementById('courseModalTitle').innerText = "Ch·ªânh s·ª≠a kh√≥a h·ªçc"; document.getElementById('courseId').value = data.id; document.getElementById('inpTitle').value = data.title; document.getElementById('inpPrice').value = data.price_tokens; document.getElementById('inpImage').value = data.image_url; document.getElementById('inpDesc').value = data.description; const container = document.getElementById('classListContainer'); container.innerHTML = ""; if(data.classes && data.classes.length > 0) { data.classes.forEach(cls => addClassItem(cls)); } else { addClassItem(); } new bootstrap.Modal(document.getElementById('courseModal')).show(); 
            }
        }
        
        function addClassItem(data = null) { 
            const container = document.getElementById('classListContainer'); const id = Date.now() + Math.floor(Math.random()*1000); 
            let days = [], start = "08:00", end = "10:00"; 
            if (data && data.schedule) { try { const parts = data.schedule.split('('); days = parts[0].replace(/\s+/g, '').split(',').filter(d=>d); const timePart = parts[1].replace(')', '').trim(); const times = timePart.split('-'); if (times.length >= 2) { start = times[0].trim(); end = times[1].trim(); } } catch(e) {} } 
            const html = `<div class="card mb-3 border shadow-sm class-item" id="class-${id}"><input type="hidden" class="inp-class-id" value="${data?data.id:''}"><div class="card-body"><div class="d-flex justify-content-between mb-2"><h6 class="fw-bold text-dark"><i class="fas fa-layer-group me-2"></i>Th√¥ng tin l·ªõp</h6><button type="button" class="btn-close" onclick="document.getElementById('class-${id}').remove()"></button></div><div class="row g-2 mb-3"><div class="col-md-6"><label class="small text-muted fw-bold">T√™n l·ªõp</label><input type="text" class="form-control form-control-sm inp-name" value="${data?data.name:''}" placeholder="VD: L·ªõp A" required></div><div class="col-md-6"><label class="small text-muted fw-bold">Sƒ© s·ªë</label><input type="number" class="form-control form-control-sm inp-capacity" value="${data?data.capacity:30}"></div></div><div class="row g-2 mb-3"><div class="col-md-6"><label class="small text-muted fw-bold">Ng√†y Khai gi·∫£ng</label><input type="date" class="form-control form-control-sm inp-start-date" value="${data?data.start_date:new Date().toISOString().split('T')[0]}" required></div><div class="col-md-6"><label class="small text-muted fw-bold">Ng√†y K·∫øt th√∫c</label><input type="date" class="form-control form-control-sm inp-end-date" value="${data?data.end_date:''}" required></div></div><div class="schedule-selector"><label class="small text-muted fw-bold mb-2 d-block">L·ªãch h·ªçc h√†ng tu·∫ßn</label><div class="d-flex align-items-center mb-3"><span class="me-2 text-muted small">Th·ª©:</span>${['2','3','4','5','6','7','CN'].map(d=>`<input type="checkbox" class="day-checkbox inp-day" id="d-${id}-${d}" value="${d}" ${days.includes(d)?'checked':''}><label for="d-${id}-${d}" class="day-label">${d}</label>`).join('')}</div><div class="d-flex gap-2 align-items-center"><span class="text-muted small">Gi·ªù:</span><input type="time" class="form-control form-control-sm inp-start" style="width:100px" value="${start}" required><span class="text-muted small">ƒê·∫øn:</span><input type="time" class="form-control form-control-sm inp-end" style="width:100px" value="${end}" required></div></div><div><label class="small text-muted fw-bold">Link Meeting</label><input type="text" class="form-control inp-link" value="${data?(data.meeting_url||''):''}" placeholder="Link Zoom/Meet..." required></div></div></div>`; 
            container.insertAdjacentHTML('beforeend', html); 
        }
        function prepareData(e) { const classItems = document.querySelectorAll('.class-item'); const classes = []; for (const item of classItems) { const id = item.querySelector('.inp-class-id').value; const name = item.querySelector('.inp-name').value; const capacity = item.querySelector('.inp-capacity').value; const link = item.querySelector('.inp-link').value; const startDate = item.querySelector('.inp-start-date').value; const endDate = item.querySelector('.inp-end-date').value; const checkedDays = Array.from(item.querySelectorAll('.inp-day:checked')).map(cb => cb.value); const start = item.querySelector('.inp-start').value; const end = item.querySelector('.inp-end').value; if (checkedDays.length === 0) { alert(`L·ªõp ${name}: Ch∆∞a ch·ªçn th·ª© h·ªçc!`); e.preventDefault(); return; } if (endDate < startDate) { alert(`L·ªõp ${name}: Ng√†y k·∫øt th√∫c sai!`); e.preventDefault(); return; } classes.push({ id: id || null, name: name, schedule: `${checkedDays.join(',')} (${start}-${end})`, start_date: startDate, end_date: endDate, capacity: capacity, meeting_url: link }); } document.getElementById('classesJson').value = JSON.stringify(classes); }
        function toggleKYCForm() { const type = document.getElementById('kycType').value; const s = document.getElementById('studentFields'); const t = document.getElementById('teacherFields'); if (type === 'student_creator') { s.style.display='block'; t.style.display='none'; enableInputs(s,true); enableInputs(t,false); } else { s.style.display='none'; t.style.display='block'; enableInputs(s,false); enableInputs(t,true); } }
        function enableInputs(div, en) { div.querySelectorAll('input').forEach(i => { i.disabled = !en; if(i.type!=='file' && en) i.required=true; }); }
        let mediaRecorder, recordedChunks = [], isRecording = false;
        async function startClassAndRecord() { const u=document.getElementById('popupMeetingUrl').value; if(u)window.open(u,'_blank'); document.getElementById('eduSmartRecorder').style.display='block'; bootstrap.Modal.getInstance(document.getElementById('classSessionModal')).hide(); }
        async function toggleRecording() { if(!isRecording){try{const s=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});mediaRecorder=new MediaRecorder(s);mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recordedChunks.push(e.data)};mediaRecorder.onstop=saveRecording;mediaRecorder.start();isRecording=true;document.getElementById('recBtn').classList.add('recording')}catch(e){}}else{mediaRecorder.stop();isRecording=false;document.getElementById('recBtn').classList.remove('recording');setTimeout(()=>document.getElementById('eduSmartRecorder').style.display='none',3000)}}
        async function saveRecording() { const b=new Blob(recordedChunks,{type:'video/webm'});const f=new FormData();f.append('video_file',b,'r.webm');f.append('class_name',document.title);fetch('/save-recording',{method:'POST',body:f}).then(r=>r.json()).then(d=>{if(d.success)alert('ƒê√£ l∆∞u video!')}); }
        function openClassSessionModal(n,e,c,p,u){document.getElementById('popupClassName').innerText=n;document.getElementById('popupTotal').innerText=e+"/"+c;document.getElementById('popupPresent').innerText=p;document.getElementById('popupAbsent').innerText=e-p;document.getElementById('popupMeetingUrl').value=u;new bootstrap.Modal(document.getElementById('classSessionModal')).show();}
        async function toggleDownload(id) { await fetch('/toggle-download', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({id}) }); }
        function confirmLogout(){new bootstrap.Modal(document.getElementById('logoutModal')).show();}
    </script>
</body>
</html>
